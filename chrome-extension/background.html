<html>
  <script>

    var currentSite = null;
    var currentTabId = null;
    var startTime = null;
    var siteRegexp = /^(\w+:\/\/[^\/]+).*$/;

    // TODO(nav): Make this more reasonable default and a user pref.
    var sendStatsInterval = 1000 * 60;  // 1 minute.
    var updateCounterInterval = 1000 * 60;  // 1 minute.

    function getSiteFromUrl(url) {
      var match = url.match(siteRegexp);
      if (match) {
        return match[1];
      }
      return null;
    }

    function updateCounter() {
      if (currentTabId == null) {
        return;
      }

      chrome.tabs.get(currentTabId, function(tab) {
        var site = getSiteFromUrl(tab.url);
        if (site == null) {
          console.log("Unable to update counter. Malformed url.");
          return;
        }

        if (currentSite == null) {
          currentSite = site;
          startTime = new Date();
          return;
        }

        var now = new Date();
        var delta = now.getTime() - startTime.getTime();
        updateTime(currentSite, delta/1000);
        currentSite = site;
        startTime = now;
      });
    }

    function sendStatistics() {
      var xhr = new XMLHttpRequest();
      var params = "sites=" + escape(localStorage.sites);
      xhr.open("POST", "http://browser-timetracker.appspot.com/stats/update", false);
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhr.send(params);
      if (xhr.status == 200) {
        console.log("Successfully updated statistics.");
        localStorage.sites = JSON.stringify({});
      } else {
        console.log("Something went wrong with updating stats: " + xhr.status);
      }
    }

    function updateTime(site, seconds) {
      var sites = JSON.parse(localStorage.sites);
      if (!sites[site]) {
        sites[site] = 0;
      }
      sites[site] = sites[site] + seconds;
      localStorage.sites = JSON.stringify(sites);
    }

    function initialize() {
      if (!localStorage.sites) {
        localStorage.sites = JSON.stringify({});
      }

      chrome.tabs.onSelectionChanged.addListener(
      function(tabId, selectionInfo) {
        console.log("Tab changed");
        currentTabId = tabId;
        updateCounter();
      });

      // Force an update of the counter every minute. Otherwise, the counter
      // only updates for selection or URL changes.
      window.setInterval(updateCounter, updateCounterInterval);

      // Send statistics periodically.
      window.setInterval(sendStatistics, sendStatsInterval);
    }

  </script>
  <body onload="initialize()">
  </body>
</html>
